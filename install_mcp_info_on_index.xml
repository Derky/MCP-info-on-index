<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http
://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.1.xsd">
	<header>
		<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
		
		<title lang="en">MCP info on index</title>
		
		<description lang="en">Adds a red box to the index when there are reported or unapproved posts (and how many). So you don't have to check the MCP everytime and you will see reports and unapproved posts faster. This is only visible for moderators or admins with moderator permissions.</description>
		
		<author-notes lang="en">To install this MOD on a subsilver2 based style. Only apply changes to index.php and then go to the subsilver2 file which is displayed below at Additional MODX Files</author-notes>
		
		<author-group>
			<author>
				<username>Derky</username>
				<homepage>http://www.phpBB3styles.net/</homepage>
			</author>
		</author-group>
		
		<mod-version>1.0.0</mod-version>
		
		<installation>
			<level>easy</level>
			<time>60</time>
			<target-version>3.0.2</target-version>
		</installation>

		<history>
			<entry>
				<date>2008-09-17</date>
				<rev-version>1.0.0</rev-version>
				<changelog lang="en">
					<change>First release</change>
				</changelog>
			</entry>
		</history>
		
		<link-group>
			<link type="template" href="contrib/subsilver2.xml" lang="en">subsilver2</link>
		</link-group>
		
	</header>
	
	<action-group>
		
		<open src="index.php">
			<edit>
				<find><![CDATA[	while ($row = $db->sql_fetchrow($result))
	{
		$birthday_list .= (($birthday_list != '') ? ', ' : '') . get_username_string('full', $row['user_id'], $row['username'], $row['user_colour']);

		if ($age = (int) substr($row['user_birthday'], -4))
		{
			$birthday_list .= ' (' . ($now['year'] - $age) . ')';
		}
	}
	$db->sql_freeresult($result);
}]]></find>
				<action type="after-add"><![CDATA[
// Show amount of reported and qeue posts for m_ auth users
if ($auth->acl_get('m_') || $auth->acl_getf_global('m_'))
{
	include($phpbb_root_path . 'includes/functions_admin.' . $phpEx);
	$user->add_lang('mcp');
	
	// Reported posts
	$forum_list = get_forum_list('m_report');
	$template->assign_var('S_SHOW_REPORTS', (!empty($forum_list)) ? true : false);

	if (!empty($forum_list))
	{
		$sql = 'SELECT COUNT(r.report_id) AS total
			FROM ' . REPORTS_TABLE . ' r, ' . POSTS_TABLE . ' p
			WHERE r.post_id = p.post_id
				AND r.report_closed = 0
				AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')';
		$result = $db->sql_query($sql);
		$total = (int) $db->sql_fetchfield('total');
		$db->sql_freeresult($result);

		if ($total > 0)
		{			
			$template->assign_vars(array(
				'L_REPORTS_TOTAL'	=> ($total == 1) ? $user->lang['REPORT_TOTAL'] : sprintf($user->lang['REPORTS_TOTAL'], $total),
				'U_REPORTS'			=> append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=reports'),
				'S_HAS_REPORTS'		=> true)
			);
		}
	}
	else
	{
		$template->assign_var('S_SHOW_REPORTS', false);
	}
	
	// Posts in queue
	$forum_list = get_forum_list('m_approve');
	if (!empty($forum_list))
	{
		$sql = 'SELECT COUNT(post_id) AS total
			FROM ' . POSTS_TABLE . '
			WHERE forum_id IN (0, ' . implode(', ', $forum_list) . ')
				AND post_approved = 0';
		$result = $db->sql_query($sql);
		$total = (int) $db->sql_fetchfield('total');
		$db->sql_freeresult($result);
		
		if ($total > 0)
		{
			$template->assign_vars(array(
				'L_UNAPPROVED_TOTAL'		=> ($total == 1) ? $user->lang['UNAPPROVED_POST_TOTAL'] : sprintf($user->lang['UNAPPROVED_POSTS_TOTAL'], $total),
				'U_QUEUE'					=> append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=queue'),
				'S_HAS_UNAPPROVED_POSTS'	=> true)
			);
		}
	}
	else
	{
		$template->assign_var('S_HAS_UNAPPROVED_POSTS', false);
	}	
}]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/index_body.html">
			<edit>
				<comment lang="en">If you use a subsilver2 (based) style, stop here and go to /contrib/subsilver2.xml</comment>
				<find><![CDATA[<!-- INCLUDE overall_header.html -->]]></find>
				<action type="after-add"><![CDATA[
<!-- IF S_HAS_REPORTS or S_HAS_UNAPPROVED_POSTS -->
<div id="message" class="rules">
    <div class="inner"><span class="corners-top"><span></span></span>
        <strong>{L_INFORMATION}:</strong> 
        <!-- IF S_HAS_REPORTS --><a href="{U_REPORTS}">{L_REPORTS_TOTAL}</a><!-- ENDIF -->
        <!-- IF S_HAS_REPORTS and S_HAS_UNAPPROVED_POSTS --> &bull; <!-- ENDIF -->
        <!-- IF S_HAS_UNAPPROVED_POSTS --><a href="{U_QUEUE}">{L_UNAPPROVED_TOTAL}</a><!-- ENDIF -->
    <span class="corners-bottom"><span></span></span></div>
</div>
<!-- ENDIF -->]]></action>
			</edit>			
		</open>
	</action-group>
</mod>